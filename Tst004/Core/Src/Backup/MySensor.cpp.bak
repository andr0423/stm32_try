/*
 * MySensor.cpp
 *
 *  Created on: 2 mar 2022
 *      Author: andrus
 */

#include <MySensor.h>

MySensor::MySensor() {
  this->init_var();
}

void MySensor::init_var() {
  this->pressure = 0;
  this->pressure_pa = 0;
  this->temperature = 0;
  this->humidity = 0;
  this->temperature_dht = 0;
  this->humidity_dht = 0;
}

void MySensor::set_bmp(I2C_HandleTypeDef *bmp) {
  bmp280_init_default_params(&this->bmp280.params);

  this->bmp280.addr = BMP280_I2C_ADDRESS_0;
//this->bmp280.addr = BMP280_I2C_ADDRESS_1;

  this->bmp280.i2c = bmp;

  while (!bmp280_init(&(this->bmp280), &(this->bmp280).params)) {
    HAL_Delay(1000);
  }
  this->bme280p = this->bmp280.id == BME280_CHIP_ID;
}

void MySensor::set_dht(DHT_sensor *dht) {
  this->use_dht = true;
  this->dht = dht;
}

void MySensor::get_data() {

  if (this->use_dht) {

    // bmp280 + dht22

    while (!bmp280_read_float(&this->bmp280, &this->temperature,
        &this->pressure_pa,
        NULL)) {
      HAL_Delay(500);
    }

    DHT_data d = DHT_getData(this->dht);
    this->humidity_dht = d.hum;
    this->temperature_dht = d.temp;
  } else {

    // bme280

    while (!bmp280_read_float(&this->bmp280, &this->temperature,
        &this->pressure_pa, &this->humidity)) {
      HAL_Delay(500);
    }
    this->humidity_dht = this->humidity;

  }

  // 1 Pa == 100 / 0.75 mm Hg
  this->pressure = this->pressure_pa * 0.75 / 100;

}

